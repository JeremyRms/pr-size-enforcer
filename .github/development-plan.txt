## üîß GitHub App: Auto-Close Large PRs (with Ignore Rules)

---

### üöÄ Objective

Build a GitHub App that:

* Monitors open PRs across all org repositories.
* Calculates total changed lines (additions + deletions), ignoring specified files.
* If LOC exceeds a configurable threshold (e.g. 500 LOC), closes the PR and posts a comment.

---

## üß© Architecture Overview

* **Framework**: [Probot](https://probot.github.io/) (Node.js)
* **Triggers**: `pull_request.opened`, `pull_request.synchronize`
* **Hosting**: [Render.com](https://render.com/)
* **Config**:

  * Threshold and ignored file suffixes loaded from JSON or `.env`
  * GitHub App credentials managed as environment variables

---

## üìÅ File Structure

```
auto-close-large-pr/
‚îú‚îÄ‚îÄ .env.example
‚îú‚îÄ‚îÄ app.yml                # GitHub App manifest
‚îú‚îÄ‚îÄ index.js               # Probot app logic
‚îú‚îÄ‚îÄ ignore-config.json     # Customizable ignore rules
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ render.yaml            # Render.com deployment config
‚îî‚îÄ‚îÄ README.md
```

---

## ‚öôÔ∏è Environment Variables

Define these in **Render.com ‚Üí Environment tab**:

| Key              | Description                  |
| ---------------- | ---------------------------- |
| `APP_ID`         | GitHub App ID                |
| `PRIVATE_KEY`    | PEM-format private key       |
| `WEBHOOK_SECRET` | GitHub webhook secret        |
| `LOC_THRESHOLD`  | Max LOC threshold (e.g. 500) |

---

## üì§ Hosting on Render.com

### ü™Ñ Step-by-Step Deployment

1. Push the code to a GitHub repo.
2. Go to [render.com](https://render.com) ‚Üí **New Web Service**.
3. Connect the repo and fill out:

   * **Build Command**: `npm install`
   * **Start Command**: `npm start`
4. Add environment variables from `.env.example`.
5. Render will assign a URL like: `https://auto-close-large-pr.onrender.com/`
6. In your GitHub App settings, set **Webhook URL** to that Render domain.

---

## üì¶ `render.yaml` (for infrastructure-as-code)

```yaml
services:
  - type: web
    name: auto-close-large-pr
    env: node
    plan: free
    buildCommand: "npm install"
    startCommand: "npm start"
    envVars:
      - key: APP_ID
        value: "your-app-id"
      - key: PRIVATE_KEY
        value: |-
          -----BEGIN RSA PRIVATE KEY-----
          YOUR-PRIVATE-KEY-HERE
          -----END RSA PRIVATE KEY-----
      - key: WEBHOOK_SECRET
        value: "your-webhook-secret"
      - key: LOC_THRESHOLD
        value: "500"
```

> ‚ö†Ô∏è Note: For multiline `PRIVATE_KEY`, Render handles `|-` YAML blocks properly.

---

## üß† Core Logic (`index.js`)

```js
const fs = require("fs");
const { Probot } = require("probot");

const config = JSON.parse(fs.readFileSync("./ignore-config.json", "utf8"));
const maxLoc = parseInt(process.env.LOC_THRESHOLD || config.max_loc || "500");

module.exports = (app) => {
  app.on(["pull_request.opened", "pull_request.synchronize"], async (context) => {
    const pr = context.payload.pull_request;
    const repo = context.payload.repository;

    const files = await context.octokit.paginate(
      context.octokit.pulls.listFiles,
      {
        owner: repo.owner.login,
        repo: repo.name,
        pull_number: pr.number,
        per_page: 100,
      }
    );

    const loc = files.reduce((sum, f) => {
      const ignored = config.ignored_suffixes.some((suffix) =>
        f.filename.endsWith(suffix)
      );
      return ignored ? sum : sum + f.additions + f.deletions;
    }, 0);

    if (loc > maxLoc) {
      await context.octokit.issues.createComment({
        owner: repo.owner.login,
        repo: repo.name,
        issue_number: pr.number,
        body: `üö´ This PR exceeds the allowed size of ${maxLoc} LOC (actual: ${loc}). Please split it into smaller parts.`,
      });

      await context.octokit.pulls.update({
        owner: repo.owner.login,
        repo: repo.name,
        pull_number: pr.number,
        state: "closed",
      });
    }
  });
};
```

---

## üß™ Testing Plan

* Install the app on a test repository.
* Create PRs with:

  * Over 500 LOC ‚Üí should auto-close
  * Only ignored files (`.snap`, `yarn.lock`) ‚Üí should stay open
* Watch logs in Render dashboard for issues

---

## üì¶ Future Features

| Feature                                   | Status |
| ----------------------------------------- | ------ |
| Ignore globs (e.g., `**/*.lock`)          | ‚ùå      |
| Allow label override (`no-auto-close`)    | ‚ùå      |
| Allow config via `.github/auto-close.yml` | ‚ùå      |
| Slack/Discord notifications               | ‚ùå      |

---

## ‚úÖ Summary

| Item            | Stack                                        |
| --------------- | -------------------------------------------- |
| Runtime         | Node.js + [Probot](https://probot.github.io) |
| Hosting         | [Render.com](https://render.com) (Free Tier) |
| Trigger         | GitHub Webhook: PR events                    |
| Security        | GitHub App + Webhook Secret                  |
| Deployment Time | \~5 minutes                                  |
